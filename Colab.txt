# BÆ¯á»šC 1: setup mÃ´i trÆ°á»ng
!sudo apt-get update -qq
!sudo apt-get install -y python3.10 python3.10-venv python3.10-dev

# BÆ¯á»šC 3: Clone repository
# ==============================
print("\nðŸ“¦ Clone repository...")

!git clone https://github.com/Cunmo-dev/F5TTS.git
%cd F5TTS


# ==============================
# BÆ¯á»šC 4: Táº¡o virtual environment vá»›i Python 3.10
# ==============================
print("\nðŸ”§ Táº¡o virtual environment vá»›i Python 3.10...")

!python3.10 -m venv env

print("âœ… ÄÃ£ táº¡o venv!")

# BÆ¯á»šC 5: CÃ i Ä‘áº·t dependencies (PyTorch vá»›i CUDA trÆ°á»›c)
# ==============================
print("\nðŸ“¦ CÃ i Ä‘áº·t PyTorch vá»›i CUDA...")

# CÃ i PyTorch vá»›i CUDA 12.1 (cho GPU)
!./env/bin/pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu121

print("\nðŸ“¦ CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cÃ²n láº¡i...")

# CÃ i cÃ¡c thÆ° viá»‡n khÃ¡c tá»« requirements.txt (bá» qua torch, torchaudio)
!./env/bin/pip install soundfile transformers "bitsandbytes>0.37.0" vinorm cached_path huggingface_hub gradio "accelerate>=0.33.0" click datasets "ema_pytorch>=0.5.2" "hydra-core>=1.3.0" jieba librosa matplotlib "numpy<=1.26.4" pydub pypinyin safetensors tomli torchdiffeq "tqdm>=4.65.0" transformers_stream_generator vocos wandb "x_transformers>=1.31.14"

print("âœ… HoÃ n táº¥t cÃ i Ä‘áº·t!")

!./env/bin/pip install spaces

# BÆ¯á»šC 7: Táº¡o script inference
# ==============================
print("\nðŸ“ Táº¡o script inference...")

inference_code = '''
import sys
import torch
import torchaudio
from cached_path import cached_path
from f5_tts.infer.utils_infer import infer_process, load_vocoder, load_model
from f5_tts.model import DiT

def synthesize(ref_audio, ref_text, gen_text):
    print("Loading model...")
    
    # Config
    model_path = "hynt/F5-TTS-Vietnamese-100h"
    vocab_file = cached_path(f"hf://{model_path}/vocab.txt")
    ckpt_file = cached_path(f"hf://{model_path}/model_500000.pt")
    
    # Load vocab
    with open(vocab_file, "r", encoding="utf-8") as f:
        vocab_list = [line.strip() for line in f]
    vocab_char_map = {char: i for i, char in enumerate(vocab_list)}
    vocab_size = len(vocab_char_map)
    
    # Model config
    model_cfg = dict(dim=1024, depth=22, heads=16, ff_mult=2, text_dim=512, conv_layers=4)
    
    device = "cuda" if torch.cuda.is_available() else "cpu"
    model = DiT(**model_cfg, text_num_embeds=vocab_size, mel_dim=100)
    
    # Load checkpoint
    ckpt = torch.load(ckpt_file, map_location=device, weights_only=True)
    model.load_state_dict(ckpt["model_state_dict"])
    model = model.to(device)
    model.eval()
    
    # Load vocoder
    vocoder = load_vocoder(vocoder_name="vocos")
    
    print("Synthesizing...")
    
    # Normalize
    ref_text = ref_text.lower().strip()
    gen_text = gen_text.lower().strip()
    
    # Inference
    audio, sr, _ = infer_process(
        ref_audio, ref_text, gen_text,
        model, vocoder,
        mel_spec_type="vocos",
        speed=1.0,
        device=device
    )
    
    # Save
    output = "output.wav"
    torchaudio.save(output, audio, sr)
    print(f"Saved: {output}")
    return output

if __name__ == "__main__":
    synthesize(sys.argv[1], sys.argv[2], sys.argv[3])
'''

with open("inference.py", "w") as f:
    f.write(inference_code)

print("âœ… ÄÃ£ táº¡o inference.py!")

# Downgrade transformers Ä‘á»ƒ bá» qua check PyTorch 2.6
!./env/bin/pip install "transformers==4.44.2"

# Cháº¡y láº¡i app
!pkill -f app.py  # Kill process cÅ© náº¿u cÃ³
!MPLBACKEND=Agg ./env/bin/python app.py





%cd /content
!rm -rf F5TTS
!git clone https://github.com/Cunmo-dev/F5TTS.git
%cd F5TTS

!python3.10 -m venv env
!./env/bin/pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu121
!./env/bin/pip install soundfile transformers "bitsandbytes>0.37.0" vinorm cached_path huggingface_hub gradio "accelerate>=0.33.0" click datasets "ema_pytorch>=0.5.2" "hydra-core>=1.3.0" jieba librosa matplotlib "numpy<=1.26.4" pydub pypinyin safetensors tomli torchdiffeq "tqdm>=4.65.0" transformers_stream_generator vocos wandb "x_transformers>=1.31.14" spaces
!./env/bin/pip install "transformers==4.44.2"

!./env/bin/python -m py_compile app.py
!pkill -f app.py
!MPLBACKEND=Agg ./env/bin/python app.py
